<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Attendance Signature Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- MSAL.js for Microsoft Authentication -->
    <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
    
    <!-- PDF.js for rendering PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- PDF-lib for modifying PDFs -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    
    <!-- Signature Pad -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --accent-primary: #6366f1;
            --accent-secondary: #818cf8;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #2d2d3a;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Space Grotesk',sans-serif; background:var(--bg-primary); color:var(--text-primary); min-height:100vh; line-height:1.6; }
        .header { background:var(--bg-secondary); border-bottom:1px solid var(--border-color); padding:1rem 1.5rem; position:sticky; top:0; z-index:100; }
        .header-content { max-width:1200px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:1rem; }
        .logo { font-size:1.25rem; font-weight:700; color:var(--accent-secondary); display:flex; align-items:center; gap:0.5rem; }
        .logo-icon { width:32px; height:32px; background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary)); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:1rem; }
        .container { max-width:1200px; margin:0 auto; padding:2rem 1.5rem; }
        .section { margin-bottom:2rem; }
        .section-title { font-size:1rem; font-weight:600; color:var(--text-secondary); margin-bottom:1rem; text-transform:uppercase; letter-spacing:0.05em; }
        .setup-panel { background:var(--bg-card); border:1px solid var(--border-color); border-radius:12px; padding:1.5rem; }
        .input-group { margin-bottom:1rem; }
        .input-group label { display:block; font-size:0.875rem; color:var(--text-secondary); margin-bottom:0.5rem; }
        .input-group input { width:100%; padding:0.875rem 1rem; background:var(--bg-secondary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary); font-family:'JetBrains Mono',monospace; font-size:0.875rem; transition:border-color 0.2s,box-shadow 0.2s; }
        .input-group input:focus { outline:none; border-color:var(--accent-primary); box-shadow:0 0 0 3px var(--accent-glow); }
        .input-group input::placeholder { color:var(--text-muted); }
        
        .code-input-wrapper { display:flex; justify-content:center; gap:0.75rem; margin:1.5rem 0; }
        .code-digit { width:70px; height:85px; background:var(--bg-secondary); border:2px solid var(--border-color); border-radius:12px; color:var(--text-primary); font-family:'JetBrains Mono',monospace; font-size:2.25rem; font-weight:700; text-align:center; transition:border-color 0.2s,box-shadow 0.2s; }
        .code-digit:focus { outline:none; border-color:var(--accent-primary); box-shadow:0 0 0 3px var(--accent-glow); }
        .code-digit::placeholder { color:var(--text-muted); font-size:1.5rem; }
        
        .code-display { background:linear-gradient(135deg,rgba(99,102,241,0.15),rgba(129,140,248,0.1)); border:2px solid var(--accent-primary); border-radius:16px; padding:2rem; text-align:center; margin:1.5rem 0; }
        .code-display-label { font-size:0.875rem; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.1em; margin-bottom:0.75rem; }
        .code-display-value { font-family:'JetBrains Mono',monospace; font-size:3.5rem; font-weight:700; color:var(--accent-secondary); letter-spacing:0.5rem; }
        .code-display-hint { font-size:0.8125rem; color:var(--text-muted); margin-top:0.75rem; }
        
        .mode-switcher { display:flex; background:var(--bg-secondary); border:1px solid var(--border-color); border-radius:10px; padding:4px; margin-bottom:1.5rem; }
        .mode-btn { flex:1; padding:0.75rem 1rem; background:transparent; border:none; border-radius:8px; color:var(--text-muted); font-family:'Space Grotesk',sans-serif; font-size:0.9375rem; font-weight:600; cursor:pointer; transition:all 0.2s; }
        .mode-btn.active { background:var(--accent-primary); color:white; box-shadow:0 2px 8px var(--accent-glow); }
        .mode-btn:hover:not(.active) { color:var(--text-secondary); }
        
        .btn { display:inline-flex; align-items:center; justify-content:center; gap:0.5rem; padding:0.875rem 1.5rem; font-family:'Space Grotesk',sans-serif; font-size:0.9375rem; font-weight:600; border:none; border-radius:8px; cursor:pointer; transition:all 0.2s; }
        .btn-primary { background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary)); color:white; }
        .btn-primary:hover { transform:translateY(-2px); box-shadow:0 4px 20px var(--accent-glow); }
        .btn-secondary { background:var(--bg-secondary); color:var(--text-primary); border:1px solid var(--border-color); }
        .btn-secondary:hover { background:var(--bg-card); border-color:var(--accent-primary); }
        .btn-success { background:var(--success); color:white; }
        .btn-success:hover { background:#0d9668; }
        .btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; }
        .btn-group { display:flex; gap:0.75rem; flex-wrap:wrap; }
        .btn-full { width:100%; }
        
        .status { display:flex; align-items:center; gap:0.5rem; padding:0.75rem 1rem; border-radius:8px; font-size:0.875rem; margin-top:1rem; }
        .status-info { background:rgba(99,102,241,0.1); border:1px solid rgba(99,102,241,0.3); color:var(--accent-secondary); }
        .status-success { background:rgba(16,185,129,0.1); border:1px solid rgba(16,185,129,0.3); color:var(--success); }
        .status-error { background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.3); color:var(--error); }
        .status-loading { background:rgba(245,158,11,0.1); border:1px solid rgba(245,158,11,0.3); color:var(--warning); }
        
        .participant-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:1rem; }
        .participant-card { background:var(--bg-card); border:2px solid var(--border-color); border-radius:12px; padding:1.25rem; cursor:pointer; transition:all 0.2s; text-align:center; }
        .participant-card:hover { border-color:var(--accent-primary); transform:translateY(-2px); box-shadow:0 4px 20px rgba(0,0,0,0.3); }
        .participant-card:active { transform:translateY(0); }
        .participant-name { font-size:1.125rem; font-weight:600; color:var(--text-primary); word-break:break-word; }
        .participant-status { font-size:0.75rem; color:var(--text-muted); margin-top:0.5rem; }
        
        .modal-overlay { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.9); z-index:1000; display:none; overflow-y:auto; padding:1rem; }
        .modal-overlay.active { display:flex; align-items:flex-start; justify-content:center; }
        .modal-content { background:var(--bg-secondary); border:1px solid var(--border-color); border-radius:16px; width:100%; max-width:900px; margin:1rem auto; overflow:hidden; }
        .modal-header { display:flex; justify-content:space-between; align-items:center; padding:1rem 1.5rem; border-bottom:1px solid var(--border-color); }
        .modal-title { font-size:1.125rem; font-weight:600; }
        .modal-close { background:none; border:none; color:var(--text-secondary); font-size:1.5rem; cursor:pointer; padding:0.25rem; line-height:1; }
        .modal-close:hover { color:var(--text-primary); }
        .modal-body { padding:1.5rem; }
        .pdf-container { background:var(--bg-card); border-radius:8px; padding:1rem; margin-bottom:1.5rem; overflow-x:auto; display:flex; justify-content:center; }
        #pdf-canvas { max-width:100%; height:auto; border-radius:4px; }
        .signature-section { background:var(--bg-card); border-radius:12px; padding:1.5rem; }
        .signature-label { font-size:0.875rem; font-weight:600; color:var(--text-secondary); margin-bottom:0.75rem; text-transform:uppercase; letter-spacing:0.05em; }
        .signature-pad-container { background:white; border-radius:8px; margin-bottom:1rem; position:relative; }
        #signature-pad { width:100%; height:200px; border-radius:8px; touch-action:none; }
        .signature-hint { font-size:0.75rem; color:var(--text-muted); text-align:center; margin-bottom:1rem; }
        .signature-actions { display:flex; gap:0.75rem; flex-wrap:wrap; }
        .signature-actions .btn { flex:1; min-width:120px; }
        .spinner { width:20px; height:20px; border:2px solid transparent; border-top-color:currentColor; border-radius:50%; animation:spin 0.8s linear infinite; }
        @keyframes spin { to { transform:rotate(360deg); } }
        .hidden { display:none !important; }
        .instructions { background:rgba(99,102,241,0.05); border:1px solid rgba(99,102,241,0.2); border-radius:8px; padding:1rem; margin-bottom:1rem; font-size:0.875rem; color:var(--text-secondary); }
        .instructions ol { margin-left:1.25rem; }
        .instructions li { margin-bottom:0.5rem; }
        .user-info { display:flex; align-items:center; gap:0.75rem; font-size:0.875rem; color:var(--text-secondary); }
        .user-avatar { width:32px; height:32px; background:var(--accent-primary); border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:600; color:white; font-size:0.875rem; }
        
        @media (max-width:640px) {
            .header-content { flex-direction:column; align-items:stretch; }
            .participant-grid { grid-template-columns:1fr; }
            .modal-content { margin:0.5rem; border-radius:12px; }
            .modal-body { padding:1rem; }
            #signature-pad { height:150px; }
            .code-digit { width:60px; height:72px; font-size:1.75rem; }
            .code-display-value { font-size:2.5rem; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">‚úçÔ∏è</div>
                <span>Attendance Signature</span>
            </div>
            <div id="user-section" class="hidden">
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <span id="user-name">User</span>
                    <button class="btn btn-secondary" id="btn-signout" style="padding:0.5rem 1rem; font-size:0.8125rem;">Sign Out</button>
                </div>
            </div>
        </div>
    </header>
    
    <main class="container">
        <!-- Mode Selection -->
        <section class="section">
            <div class="mode-switcher">
                <button class="mode-btn active" id="mode-participant" onclick="switchMode('participant')">üë§ Participant</button>
                <button class="mode-btn" id="mode-admin" onclick="switchMode('admin')">üîß Admin</button>
            </div>
        </section>

        <!-- PARTICIPANT MODE -->
        <section class="section" id="participant-mode">
            <div class="setup-panel">
                <div class="instructions">
                    <strong>How to sign your attendance:</strong>
                    <ol>
                        <li>Enter the <strong>4-digit code</strong> given by your trainer</li>
                        <li>Sign in with your Microsoft account</li>
                        <li>Select your name from the list</li>
                        <li>Draw your signature and save</li>
                    </ol>
                </div>
                
                <label style="display:block; text-align:center; font-size:0.875rem; color:var(--text-secondary); margin-bottom:0.5rem;">Enter your class code</label>
                <div class="code-input-wrapper">
                    <input type="text" class="code-digit" id="code-1" maxlength="1" inputmode="numeric" pattern="[0-9]" placeholder="¬∑" autocomplete="off">
                    <input type="text" class="code-digit" id="code-2" maxlength="1" inputmode="numeric" pattern="[0-9]" placeholder="¬∑" autocomplete="off">
                    <input type="text" class="code-digit" id="code-3" maxlength="1" inputmode="numeric" pattern="[0-9]" placeholder="¬∑" autocomplete="off">
                    <input type="text" class="code-digit" id="code-4" maxlength="1" inputmode="numeric" pattern="[0-9]" placeholder="¬∑" autocomplete="off">
                </div>
                
                <button class="btn btn-primary btn-full" id="btn-lookup-code" disabled>Look Up Class</button>
                <div id="code-status-container"></div>
                
                <div id="participant-signin-section" class="hidden" style="margin-top:1.5rem; padding-top:1.5rem; border-top:1px solid var(--border-color);">
                    <button class="btn btn-primary btn-full" id="btn-signin-participant">Sign In with Microsoft</button>
                </div>
            </div>
        </section>

        <!-- ADMIN MODE -->
        <section class="section hidden" id="admin-mode">
            <div class="setup-panel">
                <div class="instructions">
                    <strong>Admin: Generate a class code</strong>
                    <ol>
                        <li>Sign in with your Microsoft account</li>
                        <li>Paste the SharePoint/OneDrive folder link</li>
                        <li>Optionally name the class</li>
                        <li>Click "Generate Code" to create a 4-digit code</li>
                        <li>Share the code with your participants</li>
                    </ol>
                </div>
                
                <div class="btn-group" style="margin-bottom:1rem;">
                    <button class="btn btn-primary" id="btn-signin-admin">Sign In with Microsoft</button>
                </div>
                
                <div id="admin-setup" class="hidden">
                    <div class="input-group">
                        <label for="folder-link">SharePoint/OneDrive Folder Link</label>
                        <input type="text" id="folder-link" placeholder="https://yourcompany.sharepoint.com/:f:/s/..." />
                    </div>
                    <div class="input-group">
                        <label for="class-name">Class Name (optional)</label>
                        <input type="text" id="class-name" placeholder="e.g., AI for Sales - Mondi Group" style="font-family:'Space Grotesk',sans-serif;" />
                    </div>
                    <button class="btn btn-success btn-full" id="btn-generate-code">Generate Code</button>
                </div>
                
                <div id="generated-code-display" class="hidden">
                    <div class="code-display">
                        <div class="code-display-label">Your Class Code</div>
                        <div class="code-display-value" id="generated-code-value">----</div>
                        <div class="code-display-hint">Share this code with your participants</div>
                    </div>
                    <button class="btn btn-secondary btn-full" id="btn-copy-code" style="margin-bottom:0.75rem;">üìã Copy Code</button>
                    <button class="btn btn-primary btn-full" id="btn-load-from-code">Load Participants Now</button>
                </div>
                
                <div id="admin-status-container"></div>
            </div>
        </section>

        <!-- Participants Section (shared) -->
        <section class="section hidden" id="participants-section">
            <h2 class="section-title">Select Your Name</h2>
            <div class="participant-grid" id="participant-grid"></div>
        </section>
    </main>
    
    <!-- Signature Modal -->
    <div class="modal-overlay" id="signature-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-participant-name">Participant Name</h3>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="pdf-container"><canvas id="pdf-canvas"></canvas></div>
                <div class="signature-section">
                    <div class="signature-label">Draw Your Signature Below</div>
                    <div class="signature-pad-container"><canvas id="signature-pad"></canvas></div>
                    <p class="signature-hint">Use your finger or stylus to sign. Your signature will appear in the "Candidate" box on the document.</p>
                    <div class="signature-actions">
                        <button class="btn btn-secondary" id="btn-clear-signature">Clear</button>
                        <button class="btn btn-success" id="btn-save-signature">Save Signature</button>
                    </div>
                </div>
                <div id="modal-status-container"></div>
            </div>
        </div>
    </div>
    
    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const msalConfig = {
            auth: {
                clientId: "aec5d54c-af0f-4312-85bf-59eadb83b008",
                authority: "https://login.microsoftonline.com/095a44f7-c3d6-450a-9455-0b4de9a28c1c",
                redirectUri: window.location.origin + window.location.pathname,
            },
            cache: { cacheLocation: "sessionStorage", storeAuthStateInCookie: false }
        };
        
        const loginRequest = { scopes: ["Files.ReadWrite.All", "Sites.ReadWrite.All"] };
        
        // =============================================
        // NOTION CONFIG
        // Replace NOTION_TOKEN with your Notion Internal Integration Token
        // Get one at: https://www.notion.so/my-integrations
        // Then share the "Attendance Codes" database with your integration
        // =============================================
        const NOTION_TOKEN = "REPLACE_WITH_YOUR_NOTION_INTEGRATION_TOKEN";
        const NOTION_DATABASE_ID = "91c8e32342e242eba4b563a4f6f06aa9";
        const NOTION_API = "https://api.notion.com/v1";
        
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // ============================================
        // STATE
        // ============================================
        let msalInstance = null;
        let accessToken = null;
        let currentUser = null;
        let signaturePad = null;
        let currentPdfFile = null;
        let currentPdfBytes = null;
        let driveInfo = null;
        let currentMode = 'participant';
        let resolvedFolderLink = null;
        
        // ============================================
        // DOM
        // ============================================
        const el = {
            modeParticipant: document.getElementById('mode-participant'),
            modeAdmin: document.getElementById('mode-admin'),
            participantMode: document.getElementById('participant-mode'),
            adminMode: document.getElementById('admin-mode'),
            codeDigits: [document.getElementById('code-1'), document.getElementById('code-2'), document.getElementById('code-3'), document.getElementById('code-4')],
            btnLookupCode: document.getElementById('btn-lookup-code'),
            codeStatusContainer: document.getElementById('code-status-container'),
            participantSigninSection: document.getElementById('participant-signin-section'),
            btnSigninParticipant: document.getElementById('btn-signin-participant'),
            btnSigninAdmin: document.getElementById('btn-signin-admin'),
            adminSetup: document.getElementById('admin-setup'),
            folderLink: document.getElementById('folder-link'),
            className: document.getElementById('class-name'),
            btnGenerateCode: document.getElementById('btn-generate-code'),
            generatedCodeDisplay: document.getElementById('generated-code-display'),
            generatedCodeValue: document.getElementById('generated-code-value'),
            btnCopyCode: document.getElementById('btn-copy-code'),
            btnLoadFromCode: document.getElementById('btn-load-from-code'),
            adminStatusContainer: document.getElementById('admin-status-container'),
            btnSignout: document.getElementById('btn-signout'),
            userSection: document.getElementById('user-section'),
            userName: document.getElementById('user-name'),
            userAvatar: document.getElementById('user-avatar'),
            participantsSection: document.getElementById('participants-section'),
            participantGrid: document.getElementById('participant-grid'),
            signatureModal: document.getElementById('signature-modal'),
            modalClose: document.getElementById('modal-close'),
            modalParticipantName: document.getElementById('modal-participant-name'),
            pdfCanvas: document.getElementById('pdf-canvas'),
            signaturePadCanvas: document.getElementById('signature-pad'),
            btnClearSignature: document.getElementById('btn-clear-signature'),
            btnSaveSignature: document.getElementById('btn-save-signature'),
            modalStatusContainer: document.getElementById('modal-status-container'),
        };
        
        // ============================================
        // MODE SWITCHING
        // ============================================
        function switchMode(mode) {
            currentMode = mode;
            el.modeParticipant.classList.toggle('active', mode === 'participant');
            el.modeAdmin.classList.toggle('active', mode === 'admin');
            el.participantMode.classList.toggle('hidden', mode !== 'participant');
            el.adminMode.classList.toggle('hidden', mode !== 'admin');
            el.participantsSection.classList.add('hidden');
        }
        
        // ============================================
        // CODE INPUT HANDLING
        // ============================================
        function setupCodeInputs() {
            el.codeDigits.forEach((input, i) => {
                input.addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                    if (e.target.value && i < 3) el.codeDigits[i + 1].focus();
                    checkCodeComplete();
                });
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && i > 0) el.codeDigits[i - 1].focus();
                    if (e.key === 'Enter' && getCode().length === 4) lookupCode();
                });
                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const pasted = (e.clipboardData || window.clipboardData).getData('text').replace(/[^0-9]/g, '');
                    for (let j = 0; j < Math.min(pasted.length, 4); j++) el.codeDigits[j].value = pasted[j];
                    if (pasted.length >= 4) el.codeDigits[3].focus();
                    checkCodeComplete();
                });
            });
        }
        
        function getCode() { return el.codeDigits.map(d => d.value).join(''); }
        function checkCodeComplete() { el.btnLookupCode.disabled = getCode().length !== 4; }
        
        // ============================================
        // NOTION API
        // ============================================
        function genCode() { return String(Math.floor(1000 + Math.random() * 9000)); }
        
        async function notionQuery(code) {
            const r = await fetch(`${NOTION_API}/databases/${NOTION_DATABASE_ID}/query`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${NOTION_TOKEN}`, 'Content-Type': 'application/json', 'Notion-Version': '2022-06-28' },
                body: JSON.stringify({ filter: { and: [{ property: "Code", title: { equals: code } }, { property: "Status", select: { equals: "Active" } }] } })
            });
            if (!r.ok) throw new Error(`Notion: ${r.status}`);
            return r.json();
        }
        
        async function notionCreate(code, link, name) {
            const props = { "Code": { title: [{ text: { content: code } }] }, "Folder Link": { url: link }, "Status": { select: { name: "Active" } } };
            if (name) props["Class Name"] = { rich_text: [{ text: { content: name } }] };
            const r = await fetch(`${NOTION_API}/pages`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${NOTION_TOKEN}`, 'Content-Type': 'application/json', 'Notion-Version': '2022-06-28' },
                body: JSON.stringify({ parent: { database_id: NOTION_DATABASE_ID }, properties: props })
            });
            if (!r.ok) throw new Error(`Notion: ${r.status}`);
            return r.json();
        }
        
        // ============================================
        // CODE LOOKUP (Participant)
        // ============================================
        async function lookupCode() {
            const code = getCode();
            if (code.length !== 4) return;
            
            try {
                showStatus(el.codeStatusContainer, 'Looking up class code...', 'loading');
                
                let found = false;
                
                // Try Notion API
                try {
                    const result = await notionQuery(code);
                    if (result.results?.length > 0) {
                        const entry = result.results[0];
                        resolvedFolderLink = entry.properties["Folder Link"].url;
                        const cn = entry.properties["Class Name"]?.rich_text;
                        const className = cn?.length > 0 ? cn[0].plain_text : '';
                        showStatus(el.codeStatusContainer, `‚úì ${className ? 'Class: ' + className : 'Class found!'}`, 'success');
                        el.participantSigninSection.classList.remove('hidden');
                        found = true;
                    }
                } catch (e) {
                    console.warn('Notion API failed, trying localStorage:', e);
                }
                
                // Fallback: localStorage
                if (!found) {
                    const stored = localStorage.getItem(`att_code_${code}`);
                    if (stored) {
                        const data = JSON.parse(stored);
                        resolvedFolderLink = data.folderLink;
                        showStatus(el.codeStatusContainer, `‚úì ${data.className ? 'Class: ' + data.className : 'Class found!'}`, 'success');
                        el.participantSigninSection.classList.remove('hidden');
                        found = true;
                    }
                }
                
                if (!found) {
                    showStatus(el.codeStatusContainer, 'Invalid code. Please check with your trainer.', 'error');
                }
                
            } catch (error) {
                console.error('Lookup error:', error);
                showStatus(el.codeStatusContainer, 'Error looking up code. Try again.', 'error');
            }
        }
        
        // ============================================
        // CODE GENERATION (Admin)
        // ============================================
        async function generateCodeAction() {
            const link = el.folderLink.value.trim();
            const name = el.className.value.trim();
            
            if (!link) { showStatus(el.adminStatusContainer, 'Please enter a folder link', 'error'); return; }
            
            try {
                showStatus(el.adminStatusContainer, 'Generating code...', 'loading');
                
                let code = genCode();
                let notionOk = false;
                
                try {
                    // Ensure unique
                    let ex = await notionQuery(code);
                    let attempts = 0;
                    while (ex.results?.length > 0 && attempts < 10) { code = genCode(); ex = await notionQuery(code); attempts++; }
                    await notionCreate(code, link, name);
                    notionOk = true;
                } catch (e) { console.warn('Notion save failed:', e); }
                
                // Always save to localStorage as backup
                localStorage.setItem(`att_code_${code}`, JSON.stringify({ folderLink: link, className: name, created: new Date().toISOString() }));
                resolvedFolderLink = link;
                
                el.generatedCodeValue.textContent = code;
                el.generatedCodeDisplay.classList.remove('hidden');
                
                showStatus(el.adminStatusContainer, `Code generated! ${notionOk ? '(saved to Notion ‚úì)' : '(saved locally)'}`, 'success');
                
            } catch (error) {
                console.error('Generate error:', error);
                showStatus(el.adminStatusContainer, 'Error: ' + error.message, 'error');
            }
        }
        
        function copyCode() {
            navigator.clipboard.writeText(el.generatedCodeValue.textContent).then(() => {
                el.btnCopyCode.textContent = '‚úì Copied!';
                setTimeout(() => { el.btnCopyCode.textContent = 'üìã Copy Code'; }, 2000);
            });
        }
        
        // ============================================
        // UTILITIES
        // ============================================
        function showStatus(c, msg, type = 'info') {
            c.innerHTML = `<div class="status status-${type}">${type === 'loading' ? '<div class="spinner"></div>' : ''}<span>${msg}</span></div>`;
        }
        function clearStatus(c) { c.innerHTML = ''; }
        
        // ============================================
        // MSAL AUTH
        // ============================================
        async function initMsal() {
            msalInstance = new msal.PublicClientApplication(msalConfig);
            await msalInstance.initialize();
            try {
                const r = await msalInstance.handleRedirectPromise();
                if (r) { accessToken = r.accessToken; currentUser = r.account; updateSignedIn(); }
            } catch (e) { console.error('Redirect error:', e); }
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) { currentUser = accounts[0]; await silentToken(); updateSignedIn(); }
        }
        
        async function doSignIn() {
            const sc = currentMode === 'participant' ? el.codeStatusContainer : el.adminStatusContainer;
            try {
                showStatus(sc, 'Signing in...', 'loading');
                const r = await msalInstance.loginPopup(loginRequest);
                accessToken = r.accessToken; currentUser = r.account;
                updateSignedIn();
                showStatus(sc, 'Signed in!', 'success');
                if (currentMode === 'participant' && resolvedFolderLink) await loadFiles(resolvedFolderLink);
            } catch (e) { console.error('Sign in error:', e); showStatus(sc, 'Sign in failed: ' + e.message, 'error'); }
        }
        
        async function doSignOut() {
            try { await msalInstance.logoutPopup(); } catch (e) {}
            accessToken = null; currentUser = null;
            el.userSection.classList.add('hidden');
            el.participantsSection.classList.add('hidden');
            if (currentMode === 'admin') { el.btnSigninAdmin.classList.remove('hidden'); el.adminSetup.classList.add('hidden'); el.generatedCodeDisplay.classList.add('hidden'); }
        }
        
        async function silentToken() {
            try { const r = await msalInstance.acquireTokenSilent({ ...loginRequest, account: currentUser }); accessToken = r.accessToken; }
            catch (e) { await doSignIn(); }
        }
        
        function updateSignedIn() {
            el.userSection.classList.remove('hidden');
            el.userName.textContent = currentUser.name || currentUser.username;
            el.userAvatar.textContent = (currentUser.name || currentUser.username).charAt(0).toUpperCase();
            if (currentMode === 'admin') { el.btnSigninAdmin.classList.add('hidden'); el.adminSetup.classList.remove('hidden'); }
        }
        
        // ============================================
        // GRAPH API
        // ============================================
        async function graphReq(endpoint, opts = {}) {
            if (!accessToken) await silentToken();
            const r = await fetch(`https://graph.microsoft.com/v1.0${endpoint}`, { ...opts, headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json', ...opts.headers } });
            if (!r.ok) { const t = await r.text(); throw new Error(`Graph: ${r.status} - ${t}`); }
            if (opts.responseType === 'arraybuffer') return r.arrayBuffer();
            const t = await r.text(); return t ? JSON.parse(t) : null;
        }
        
        async function resolveSharingLink(url) {
            const b64 = btoa(url).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
            return graphReq(`/shares/u!${b64}/driveItem`);
        }
        
        async function loadFiles(folderUrl) {
            const sc = currentMode === 'participant' ? el.codeStatusContainer : el.adminStatusContainer;
            if (!folderUrl) { showStatus(sc, 'No folder link', 'error'); return; }
            try {
                showStatus(sc, 'Loading participants...', 'loading');
                const item = await resolveSharingLink(folderUrl);
                if (!item) throw new Error('Could not access folder');
                driveInfo = { driveId: item.parentReference.driveId, folderId: item.id, folderName: item.name };
                const resp = await graphReq(`/drives/${driveInfo.driveId}/items/${driveInfo.folderId}/children`);
                const pdfs = resp.value.filter(i => i.name.toLowerCase().endsWith('.pdf')).map(i => ({ id: i.id, name: i.name, displayName: i.name.replace(/\.pdf$/i, '') }));
                if (!pdfs.length) { showStatus(sc, 'No PDF files found', 'error'); return; }
                displayParticipants(pdfs);
                showStatus(sc, `Found ${pdfs.length} participant(s)`, 'success');
            } catch (e) { console.error('Load error:', e); showStatus(sc, 'Error: ' + e.message, 'error'); }
        }
        
        function displayParticipants(files) {
            el.participantGrid.innerHTML = '';
            files.forEach(f => {
                const card = document.createElement('div');
                card.className = 'participant-card';
                card.innerHTML = `<div class="participant-name">${f.displayName}</div><div class="participant-status">Tap to sign</div>`;
                card.addEventListener('click', () => openModal(f));
                el.participantGrid.appendChild(card);
            });
            el.participantsSection.classList.remove('hidden');
        }
        
        // ============================================
        // SIGNATURE MODAL
        // ============================================
        async function openModal(file) {
            currentPdfFile = file;
            el.modalParticipantName.textContent = file.displayName;
            el.signatureModal.classList.add('active');
            initSigPad();
            await loadPdf(file);
        }
        
        function closeModal() {
            el.signatureModal.classList.remove('active');
            currentPdfFile = null; currentPdfBytes = null;
            clearStatus(el.modalStatusContainer);
            if (signaturePad) signaturePad.clear();
        }
        
        function initSigPad() {
            const c = el.signaturePadCanvas, p = c.parentElement;
            const r = Math.max(window.devicePixelRatio || 1, 1);
            c.width = p.offsetWidth * r; c.height = 200 * r;
            c.style.width = p.offsetWidth + 'px'; c.style.height = '200px';
            c.getContext('2d').scale(r, r);
            signaturePad = new SignaturePad(c, { backgroundColor: 'rgb(255,255,255)', penColor: 'rgb(0,0,0)', minWidth: 1, maxWidth: 3 });
        }
        
        async function loadPdf(file) {
            try {
                showStatus(el.modalStatusContainer, 'Loading document...', 'loading');
                const bytes = await graphReq(`/drives/${driveInfo.driveId}/items/${file.id}/content`, { responseType: 'arraybuffer' });
                currentPdfBytes = new Uint8Array(bytes).slice();
                const pdf = await pdfjsLib.getDocument({ data: currentPdfBytes.slice() }).promise;
                const page = await pdf.getPage(1);
                const canvas = el.pdfCanvas, ctx = canvas.getContext('2d');
                const cw = canvas.parentElement.offsetWidth - 32;
                const vp = page.getViewport({ scale: 1 });
                const s = Math.min(cw / vp.width, 1.5);
                const svp = page.getViewport({ scale: s });
                canvas.width = svp.width; canvas.height = svp.height;
                await page.render({ canvasContext: ctx, viewport: svp }).promise;
                clearStatus(el.modalStatusContainer);
            } catch (e) { console.error('PDF error:', e); showStatus(el.modalStatusContainer, 'Error: ' + e.message, 'error'); }
        }
        
        async function saveSig() {
            if (!signaturePad || signaturePad.isEmpty()) { showStatus(el.modalStatusContainer, 'Please draw your signature first', 'error'); return; }
            if (!currentPdfBytes || !currentPdfFile) { showStatus(el.modalStatusContainer, 'No document loaded', 'error'); return; }
            
            try {
                showStatus(el.modalStatusContainer, 'Saving signature...', 'loading');
                const sigUrl = signaturePad.toDataURL('image/png');
                const sigBytes = await fetch(sigUrl).then(r => r.arrayBuffer());
                const pdfDoc = await PDFLib.PDFDocument.load(currentPdfBytes.slice());
                const page = pdfDoc.getPages()[0];
                const sigImg = await pdfDoc.embedPng(sigBytes);
                const { width, height } = page.getSize();
                const sw = 100, sh = (sigImg.height / sigImg.width) * sw;
                
                // Signature position - confirmed by user
                page.drawImage(sigImg, { x: 410, y: 375, width: sw, height: sh });
                
                const modified = await pdfDoc.save();
                const ep = `/drives/${driveInfo.driveId}/items/${currentPdfFile.id}/content`;
                console.log('Uploading to:', ep, 'Size:', modified.byteLength);
                
                const ur = await fetch(`https://graph.microsoft.com/v1.0${ep}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/pdf' },
                    body: new Uint8Array(modified)
                });
                console.log('Upload status:', ur.status);
                if (!ur.ok) { const et = await ur.text(); throw new Error(`Upload failed: ${ur.status} - ${et}`); }
                console.log('Upload OK:', await ur.json());
                
                showStatus(el.modalStatusContainer, 'Signature saved successfully! ‚úì', 'success');
                
                // Refresh preview
                currentPdfBytes = new Uint8Array(modified).slice();
                const pdf = await pdfjsLib.getDocument({ data: currentPdfBytes.slice() }).promise;
                const pg = await pdf.getPage(1);
                const canvas = el.pdfCanvas, ctx = canvas.getContext('2d');
                const cw = canvas.parentElement.offsetWidth - 32;
                const vp = pg.getViewport({ scale: 1 });
                const s = Math.min(cw / vp.width, 1.5);
                const svp = pg.getViewport({ scale: s });
                canvas.width = svp.width; canvas.height = svp.height;
                await pg.render({ canvasContext: ctx, viewport: svp }).promise;
                signaturePad.clear();
                
            } catch (e) { console.error('Save error:', e); showStatus(el.modalStatusContainer, 'Error: ' + e.message, 'error'); }
        }
        
        // ============================================
        // EVENT LISTENERS
        // ============================================
        el.btnLookupCode.addEventListener('click', lookupCode);
        el.btnSigninParticipant.addEventListener('click', doSignIn);
        el.btnSigninAdmin.addEventListener('click', doSignIn);
        el.btnGenerateCode.addEventListener('click', generateCodeAction);
        el.btnCopyCode.addEventListener('click', copyCode);
        el.btnLoadFromCode.addEventListener('click', () => { if (resolvedFolderLink) loadFiles(resolvedFolderLink); });
        el.btnSignout.addEventListener('click', doSignOut);
        el.modalClose.addEventListener('click', closeModal);
        el.btnClearSignature.addEventListener('click', () => signaturePad?.clear());
        el.btnSaveSignature.addEventListener('click', saveSig);
        el.signatureModal.addEventListener('click', (e) => { if (e.target === el.signatureModal) closeModal(); });
        window.addEventListener('resize', () => { if (el.signatureModal.classList.contains('active')) initSigPad(); });
        
        // ============================================
        // INIT
        // ============================================
        document.addEventListener('DOMContentLoaded', () => { initMsal(); setupCodeInputs(); });
    </script>
</body>
</html>
